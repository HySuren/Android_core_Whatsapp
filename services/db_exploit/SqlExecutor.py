import uiautomator2 as u2


class SqlExecutor:
    def __init__(self, d: u2.Device, path_to_db: str):
        self.device = d
        self.path_to_db = path_to_db

    def execute(self, query: str) -> list[tuple] | None:
        _out, data = None, None
        _out = self.device.shell(f"su -c /data/local/sqlite3 {self.path_to_db} \"\\\"{query}\\\"\"").output

        if _out:
            _out = _out[:-1]

            if '|' in _out:
                data = _out.split('\n')

                data = self._handle_data(data)

            else:
                raise ValueError(f'Something went wrong, {_out}')

        return data

    def _handle_data(self, data) -> list[tuple] | None:
        clear_data = []
        for row in data:
            clear_row = []
            for elem in row.split('|'):
                if elem == '':
                    clear_row.append(None)
                    continue

                try:
                    clear_elem = int(elem)
                    clear_row.append(clear_elem)
                except ValueError:
                    clear_row.append(elem)

            clear_data.append(tuple(clear_row))
        return clear_data


if __name__ == '__main__':
    s = SqlExecutor(u2.connect(), '/data/data/com.whatsapp/databases/msgstore.db')
    # out = s.execute("insert into labels (label_name, predefined_id, color_id) VALUES ('test', 1, 1);")
    out1 = s.execute("INSERT INTO message(chat_row_id,from_me,key_id,sender_jid_row_id,status,broadcast,recipient_count,participant_hash,origination_flags,origin,timestamp,received_timestamp,receipt_server_timestamp,message_type,text_data,starred,lookup_tables,message_add_on_flags,sort_id) VALUES(999,1,'C9F3335ECF2D6735B603F288FAEEADEF',0,0,0,0,NULL,0,0,1680001471090,0,-1,0,'синеп',0,0,0,13);")
    print(out1)
    out2 = s.execute("select * from message;")
    print(out2)
